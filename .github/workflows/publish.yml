name: Publish to Maven Central

on:
  push:
    tags:
      - 'v*' # 当你推送 v1.0.0 等标签时触发

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Code
        uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'maven'
          # 这里的 server-id 必须和你 pom.xml 中的 <distributionManagement> 里的 ID 一致
          server-id: ossrh
          server-username: MAVEN_USERNAME
          server-password: MAVEN_PASSWORD
          # GPG 配置：setup-java 会自动处理私钥导入
          gpg-private-key: ${{ secrets.GPG_PRIVATE_KEY }}
          gpg-passphrase: GPG_PASSPHRASE

      - name: Publish to Maven Central
        run: |
          # 1. 提取版本号：从 'refs/tags/v1.2.3' 中提取出 '1.2.3'
          VERSION=${GITHUB_REF_NAME#v}
          echo "Determined version: $VERSION"
          
          # 2. 执行部署：通过 -Drevision 注入版本
          # -P release 激活 GPG 签名插件
          # -DskipTests 跳过测试以加快发布速度
          # --batch-mode 减少日志干扰
          mvn clean deploy -P release -DskipTests -Drevision=$VERSION --batch-mode

        env:
          # 将 GitHub Secrets 映射给 Maven
          MAVEN_USERNAME: ${{ secrets.OSSRH_USERNAME }}
          MAVEN_PASSWORD: ${{ secrets.OSSRH_PASSWORD }}
          GPG_PASSPHRASE: ${{ secrets.GPG_PASSPHRASE }}